<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
	<PropertyGroup>
		<ExtractLocalizationFiles Condition="'$(UpdateLocFiles)' != ''">$(UpdateLocFiles)</ExtractLocalizationFiles>
		<SkipLocalizationExtraction Condition="'$(ThrowsLocalizeError)' != ''">$(ThrowsLocalizeError)</SkipLocalizationExtraction>
		<LocalizationExtractionOutput Condition="!Exists('$(LocalizationExtractionOutput)')">$(WSRoot)\target\$(BuildConfiguration)\$(BuildPlatform)\LocExt</LocalizationExtractionOutput>
		<LocalizationDrop>$(WSRoot)\drop\Resources</LocalizationDrop>
		<MakeLang Condition="!Exists('$(MakeLang)')">$(PKG_XRMAPP_TOOLS_UPGRADE)\tools\command\MakeLang.cmd</MakeLang>
		<LocaleArgument Condition="!Exists('$(LocaleArgument)')">All</LocaleArgument>
		<PseudoLocalizeArgument>/FullPL</PseudoLocalizeArgument>
	</PropertyGroup>

	<Target Name="ExtractLocalizationResources" Condition="'$(ExtractLocalizationFiles)' == 'true' and '$(SkipLocalizationExtraction)' != 'true'">
		<Message text="Localization extraction started.." Importance="High" />
		<MakeDir Directories="$(LocalizationExtractionOutput)\$(SolutionProjectNamePrefix)" Condition="!Exists('$(LocalizationExtractionOutput)\$(SolutionProjectNamePrefix)')" />
		
		<!-- extract solution zip with /src /loc flags to produce metadata resx file -->
		<Exec Command="$(SolutionPackager) /n /action:extract /packagetype:both /folder:$(LocalizationExtractionOutput)\$(SolutionProjectNamePrefix) /zipfile:$(UnmanagedSolutionName).zip /errorLevel:verbose /src /loc" />
		
		<!-- copy resx files to destinations for local builds to check in changes -->
		<Copy SkipUnchangedFiles="true" SourceFiles="$(LocalizationExtractionOutput)\$(SolutionProjectNamePrefix)\Resources\en-US\resources.en-US.resx" DestinationFolder="$(SolutionFolder)\Resources\en-US\" 
			Condition="Exists('$(LocalizationExtractionOutput)\$(SolutionProjectNamePrefix)\Resources\en-US\resources.en-US.resx')"/>
				
		<!-- copy metadata resx file to drop folder -->
		<Exec Command="xcopy $(LocalizationExtractionOutput)\$(SolutionProjectNamePrefix)\Resources\en-US\*.resx $(LocalizationDrop)\solutions\$(SolutionProjectNamePrefix)\Solution\Resources\en-US\* /y" />
		
		<Message text="Removing temporary resource files.." Importance="High" />
		<Message text="To keep extraction output available, set KeepOutput property to true - /p:KeepOutput=true" Importance="High" />
		<Exec Command="rmdir /s /q $(LocalizationExtractionOutput)\$(SolutionProjectNamePrefix)" Condition="'$(KeepOutput)'=='false'" />
		
		<Message text="Localization extraction completed." Importance="High" />
		
		<Message text="MakeLang localization started.." Importance="High" />
		<Exec Command="$(MakeLang) $(LocaleArgument) $(PseudoLocalizeArgument) /component $(SolutionProjectNamePrefix)" Condition="Exists('$(MakeLang)')" />
		<Message text="MakeLang localization completed.." Importance="High" />

		<CallTarget Targets="GenerateSolutionFiles" />
	</Target>
	
	<Target Name="ExtractComponentLocalizationResources" Condition="'$(ExtractLocalizationFiles)' == 'true' and '$(SkipLocalizationExtraction)' != 'true'">
		<Message text="Extraction of $(MSBuildProjectName) localization started.." Importance="High" />
		
		<!-- copy component resx file to drop folder -->
		<PropertyGroup>
			<ComponentRelativePath>$(MSBuildProjectDirectory.Replace('$(WSRoot)', '$(LocalizationDrop)'))</ComponentRelativePath>
		</PropertyGroup>
		<Copy SourceFiles="@(EmbeddedResource)" DestinationFiles="@(EmbeddedResource->'$(ComponentRelativePath)\%(Identity)')" />
		
		<Message text="Extraction of $(MSBuildProjectName) localization completed." Importance="High" />
	</Target>
</Project>