<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <PropertyGroup>
    <NoWarn>2008</NoWarn>
    <LegacyProjectFile>.csproj</LegacyProjectFile>
    <SolutionPackager Condition="'$(SolutionPackager)' == ''">$(PKG_CRMSDK_CORETOOLS_UPGRADE)\content\bin\coretools\SolutionPackager.exe</SolutionPackager>
    <ControlPackager>$(PKG_XRMAPP_TOOLS_UPGRADE)\tools\XrmControlPackager\Microsoft.Dynamics.Solution.Deployment.XrmControlPackager.exe</ControlPackager>
    <SolutionOutputPath>$(WSRoot)\drop\$(BuildConfiguration)\$(BuildPlatform)\Solutions</SolutionOutputPath>
    <UnmanagedSolutionName>$(SolutionOutputPath)\$(SolutionFileNamePrefix)</UnmanagedSolutionName>
    <ManagedSolutionName>$(SolutionOutputPath)\$(SolutionFileNamePrefix)_managed</ManagedSolutionName>
    <PackagerLog>$(ApplicationFolder)\$(SolutionFileNamePrefix)_packager.log</PackagerLog>
    <UpdateSolutionVersionEnabled Condition="'$(UpdateSolutionVersionEnabled)' == ''">true</UpdateSolutionVersionEnabled>
    <LocalizeArgument Condition="'$(EnableLocalization)' == 'true'">/src /loc</LocalizeArgument>
    <PluginMapArgument Condition="('$(PluginMapFile)' != '')">/map:$(PluginMapFile)</PluginMapArgument>
    <FolderArgument Condition="('$(SolutionFolder)' != '')">/folder:$(SolutionFolder)</FolderArgument>
  </PropertyGroup>

  <Target Name="PrepareSolution" BeforeTargets="Build">
    <Message Condition="!Exists($(SolutionOutputPath))" Text="Checking for output folder.."  />
    <MakeDir Condition="!Exists($(SolutionOutputPath))" Directories="$(SolutionOutputPath)" />

    <Message Text="Solution version update enabled: $(UpdateSolutionVersionEnabled)" />
  </Target>

  <Target Name="GenerateSolutions" AfterTargets="PrepareSolution;Build">
    <CallTarget Targets="GenerateSolutionFiles" />
    <CallTarget Targets="GeneratePatchSolutionFiles" />
  </Target>

  <Target Name="GenerateSolutionFiles" Condition="'$(MSBuildProjectExtension)' == '$(LegacyProjectFile)'">
    <Message text="Solution files generation started.." Importance="High" />

    <Exec Command="$(SolutionPackager) /action:pack /packagetype:both $(PluginMapArgument) $(FolderArgument) /zipfile:$(UnmanagedSolutionName).zip $(LocalizeArgument) /errorlevel:Verbose /l:$(PackagerLog)" />
    <Exec Command="type $(PackagerLog)" Condition="Exists('$(PackagerLog)')" />

    <!-- re-package controls to include custom controls (workaround until SolutionPackager will support custom controls) -->
    <Exec Command="$(ControlPackager) $(CustomControlsPath) $(ManagedSolutionName).zip ." Condition="'$(CustomControlsPath)' != ''" />
    <Exec Command="$(ControlPackager) $(CustomControlsPath) $(UnManagedSolutionName).zip ." Condition="'$(CustomControlsPath)' != ''" />

    <Message text="Solution files generation completed." Importance="High" />
  </Target>

  <Target Name="GeneratePatchSolutionFiles" Condition="'$(GeneratePatch)' == 'true' AND Exists($(ReleasedVersion))">
    <PropertyGroup>
	    <PatchGenerator Condition="'$(PatchGenerator)' == ''">$(PKG_CRMTOOLS_PATCHGENERATOR)\tools\Microsoft.Dynamics.Crm.Tools.SolutionPatchGenerator.exe</PatchGenerator>
      <ReleasedSolution Condition="'$(ReleasedSolution)' == ''">$(ReleasedVersion)\$(SolutionFileNamePrefix)_managed.zip</ReleasedSolution>
      <UpdatedSolution>$(ManagedSolutionName).zip</UpdatedSolution>
      <PatchVersion Condition="'$(PatchVersion)' == ''">$(ResolvedArtifactVersion)</PatchVersion>
      <PatchNameSuffix Condition="'$(PatchNameSuffix)' == ''">$([System.Version]::Parse('$(PatchVersion)').Build)</PatchNameSuffix>
      <PatchName Condition="'$(PatchName)' == ''">$(SolutionIdentity)Patch$(PatchNameSuffix)</PatchName>
	  </PropertyGroup>

    <Message Text="Patch generator is $(PatchGenerator)" />
    <Message Text="Released solution is: $(ReleasedSolution)" />
    <Message Text="Updated solution is: $(UpdatedSolution)" />
    <Message Text="Patch version is: $(PatchVersion)" />
    <Message Text="Patch unique name is: $(PatchName)" />

    <Message Text="Patch solution files generation started.." Importance="High" />
    <Exec Command="$(PatchGenerator) $(ReleasedSolution) $(UpdatedSolution) $(SolutionOutputPath) $(PatchName) $(PatchVersion) " />
	  <Message Text="Patch solution files generation completed." Importance="High" />
  </Target>

  <Target Name="PostSolutionGeneration" AfterTargets="GenerateSolutions">
    <CallTarget Targets="GenerateCABSolutionFiles" />
    <CallTarget Targets="ExtractLocalizationResources" />
  </Target>

  <Target Name="GenerateCABSolutionFiles" Condition="'$(MakeCab)' != 'false'">
    <ItemGroup>
      <SolutionFiles Include="$(SolutionOutputPath)\$(SolutionFileNamePrefix)_managed.zip" />
      <SolutionFiles Include="$(SolutionOutputPath)\$(PatchName)*.zip" />
    </ItemGroup>
    
    <Message Text="Solution CAB generation started.." Importance="High" />
    <Exec Command="makecab.exe %(SolutionFiles.FullPath) $(SolutionOutputPath)\%(SolutionFiles.Filename).cab" />
    <Message text="Solution CAB generation completed." Importance="High" />
  </Target>

  <Import Project="$(WSRoot)\build\include\Localization.targets" />
</Project>